# Function to install PSWindowsUpdate module if not already installed
function Install-PSWindowsUpdateModule {
    try {
        if (-not (Get-Module -ListAvailable -Name PSWindowsUpdate)) {
            Write-Host "PSWindowsUpdate module is not installed. Installing now..." -ForegroundColor Yellow
            
            # Ensure NuGet provider is available
            if (-not (Get-PackageSource -Name 'nuget')) {
                Write-Host "NuGet provider is not installed. Installing now..." -ForegroundColor Yellow
                Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force
            }

            Install-Module -Name PSWindowsUpdate -Force -Scope CurrentUser
            Write-Host "PSWindowsUpdate module installed." -ForegroundColor Green
        } else {
            Write-Host "PSWindowsUpdate module is already installed." -ForegroundColor Green
        }
    } catch {
        Write-Host "Error installing PSWindowsUpdate module: $_" -ForegroundColor Red
    }
}

# Function to turn off the Windows Firewall for all profiles
function Disable-Firewall {
    try {
        Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False
        Write-Host "Firewall is OFF" -ForegroundColor Green -BackgroundColor Black
    } catch {
        Write-Host "Error turning off the firewall: $_" -ForegroundColor Red
    }
}

# Function to enable Remote Desktop
function Enable-RemoteDesktop {
    try {
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\' -Name "fDenyTSConnections" -Value 0
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\' -Name "UserAuthentication" -Value 0
        Write-Host "Remote Desktop is enabled" -ForegroundColor Green -BackgroundColor Black
    } catch {
        Write-Host "Error enabling Remote Desktop: $_" -ForegroundColor Red
    }
}

# Function to update Windows
function Update-Windows {
    try {
        Install-PSWindowsUpdateModule
        Import-Module PSWindowsUpdate

        Write-Host "Checking for Windows updates..." -ForegroundColor Yellow

        # Check for updates
        $updates = Get-WindowsUpdate -AcceptAll -IgnoreReboot

        if ($updates) {
            Write-Host "Updates found:" -ForegroundColor Cyan
            $updates | Format-Table -Property Title, KB, Size

            Write-Host "Downloading and installing updates..." -ForegroundColor Yellow

            # Install updates
            Install-WindowsUpdate -AcceptAll -IgnoreReboot -Verbose

            Write-Host "Updates installed." -ForegroundColor Green
            
            # Prompt user to reboot
            $reboot = Read-Host "Do you want to reboot the system now? (Y/N)"
            if ($reboot -eq 'Y') {
                Write-Host "Rebooting the system..." -ForegroundColor Yellow
                Restart-Computer -Force
            } else {
                Write-Host "Please reboot the system later to complete the update process." -ForegroundColor Yellow
            }
        } else {
            Write-Host "No updates available." -ForegroundColor Green
        }
    } catch {
        Write-Host "Error updating Windows: $_" -ForegroundColor Red
    }
}

# Function to change the computer name
function Change-ComputerName {
    try {
        $newName = Read-Host "Enter the new computer name"
        Rename-Computer -NewName $newName -Force
        Write-Host "Computer name changed to $newName." -ForegroundColor Green -BackgroundColor Black

        # Prompt user to reboot
        $reboot = Read-Host "Do you want to reboot the system now to apply the name change? (Y/N)"
        if ($reboot -eq 'Y') {
            Write-Host "Rebooting the system..." -ForegroundColor Yellow
            Restart-Computer -Force
        } else {
            Write-Host "Please reboot the system later to apply the name change." -ForegroundColor Yellow
        }
    } catch {
        Write-Host "Error changing computer name: $_" -ForegroundColor Red
    }
}

# Function to list, select, rename, and configure network adapters
function Manage-NetworkAdapters {
    try {
        # List all network adapters
        $adapters = Get-NetAdapter
        if ($adapters.Count -eq 0) {
            Write-Host "No network adapters found." -ForegroundColor Red
            return
        }

        Write-Host "Available network adapters:" -ForegroundColor Cyan
        $adapters | Format-Table -Property Name, Status, LinkSpeed

        # Select an adapter
        $adapterName = Read-Host "Enter the name of the adapter to configure"
        $selectedAdapter = $adapters | Where-Object { $_.Name -eq $adapterName }

        if (-not $selectedAdapter) {
            Write-Host "Adapter not found." -ForegroundColor Red
            return
        }

        Write-Host "Selected adapter: $($selectedAdapter.Name)" -ForegroundColor Green

        # Rename the adapter
        $newName = Read-Host "Enter the new name for the adapter"
        Rename-NetAdapter -Name $selectedAdapter.Name -NewName $newName -Confirm:$false
        Write-Host "Adapter renamed to $newName." -ForegroundColor Green

        # Configure IP settings
        $ipConfig = Read-Host "Set IP configuration - DHCP or Static? (Enter 'DHCP' or 'Static')"
        if ($ipConfig -eq 'DHCP') {
            Set-NetIPInterface -InterfaceAlias $newName -Dhcp Enabled
            Write-Host "Adapter set to DHCP." -ForegroundColor Green
        } elseif ($ipConfig -eq 'Static') {
            $ipAddress = Read-Host "Enter the static IP address"
            $subnetMask = Read-Host "Enter the subnet mask"
            $gateway = Read-Host "Enter the default gateway"
            $dnsServers = Read-Host "Enter DNS servers (comma-separated)"

            # Remove existing IP configurations
            Remove-NetIPAddress -InterfaceAlias $newName -Confirm:$false

            # Add static IP configuration
            New-NetIPAddress -InterfaceAlias $newName -IPAddress $ipAddress -PrefixLength $subnetMask -DefaultGateway $gateway
            Set-DnsClientServerAddress -InterfaceAlias $newName -ServerAddresses $dnsServers.Split(',')

            Write-Host "Adapter set to Static IP with address $ipAddress." -ForegroundColor Green
        } else {
            Write-Host "Invalid option. Please enter 'DHCP' or 'Static'." -ForegroundColor Red
        }
    } catch {
        Write-Host "Error managing network adapters: $_" -ForegroundColor Red
    }
}

# Function to change the system time zone to India Standard Time
function Change-TimeZone {
    try {
        $timeZone = 'India Standard Time'
        tzutil /s "$timeZone"
        Write-Host "Time zone changed to $timeZone." -ForegroundColor Green
    } catch {
        Write-Host "Error changing time zone: $_" -ForegroundColor Red
    }
}

# Function to change the Administrator password
function Change-AdminPassword {
    try {
        $adminAccount = [adsi]"WinNT://./Administrator,user"
        $newPasswordSecure = Read-Host "Enter the new password for Administrator" -AsSecureString
        $newPassword = [System.Runtime.InteropServices.Marshal]::PtrToStringAuto([System.Runtime.InteropServices.Marshal]::SecureStringToBSTR($newPasswordSecure))
        $adminAccount.psbase.Invoke("SetPassword", $newPassword)
        Write-Host "Administrator password changed successfully." -ForegroundColor Green
    } catch {
        Write-Host "Error changing Administrator password: $_" -ForegroundColor Red
    }
}

# Function to display the menu with green, bold-like text
function Show-Menu {
    Clear-Host
    $padding = " " * 5
    Write-Host "$padding Select an option to execute:" -ForegroundColor Green -BackgroundColor Black
    Write-Host "$padding 1: Turn off the Firewall" -ForegroundColor Green -BackgroundColor Black
    Write-Host "$padding 2: Enable Remote Desktop" -ForegroundColor Green -BackgroundColor Black
    Write-Host "$padding 3: Update Windows" -ForegroundColor Green -BackgroundColor Black
    Write-Host "$padding 4: Change Computer Name" -ForegroundColor Green -BackgroundColor Black
    Write-Host "$padding 5: Manage Network Adapters" -ForegroundColor Green -BackgroundColor Black
    Write-Host "$padding 6: Change Time Zone to (UTC+05:30) Chennai, Kolkata, Mumbai, New Delhi" -ForegroundColor Green -BackgroundColor Black
    Write-Host "$padding 7: Change Administrator Password" -ForegroundColor Green -BackgroundColor Black
    Write-Host "$padding 8: All of the Above" -ForegroundColor Green -BackgroundColor Black
    Write-Host "$padding 9: Exit" -ForegroundColor Green -BackgroundColor Black
}

# Function to execute all tasks sequentially
function Execute-AllTasks {
    Disable-Firewall
    Pause
    Enable-RemoteDesktop
    Pause
    Change-ComputerName
    Pause
    Manage-NetworkAdapters
    Pause
    Change-TimeZone
    Pause
    Change-AdminPassword
    Pause
    Update-Windows
}

# Main script execution
do {
    Show-Menu
    $choice = Read-Host "Enter your choice (1, 2, 3, 4, 5, 6, 7, 8, or 9)"
    switch ($choice) {
        '1' {
            Disable-Firewall
        }
        '2' {
            Enable-RemoteDesktop
        }
        '3' {
            Update-Windows
        }
        '4' {
            Change-ComputerName
        }
        '5' {
            Manage-NetworkAdapters
        }
        '6' {
            Change-TimeZone
        }
        '7' {
            Change-AdminPassword
        }
        '8' {
            Execute-AllTasks
        }
        '9' {
            Write-Host "Exiting..." -ForegroundColor Yellow
        }
        default {
            Write-Host "Invalid choice. Please select a valid option (1-9)." -ForegroundColor Red
        }
    }
    
    if ($choice -ne '9') {
        Pause
    }
} while ($choice -ne '9')
